From 6347fc42bd6665d2f10ca637101d36d7ae80eb76 Mon Sep 17 00:00:00 2001
From: "Aaron Sethman (androsyn)" <androsyn@ratbox.org>
Date: Fri, 4 Dec 2015 20:30:15 +0000
Subject: [PATCH 62/89] don't remove dlines while walking the patricia trie or
 corruption will result

git-svn-id: http://svn.ratbox.org/svnroot/ircd-ratbox/branches/RATBOX_3_0@29191 b93f080a-4cfa-0310-a19a-80a68f531ef9
---
 src/reject.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/reject.c b/src/reject.c
index 7dabae8..64ff8c9 100644
--- a/src/reject.c
+++ b/src/reject.c
@@ -331,16 +331,28 @@ void
 remove_perm_dlines(void)
 {
 	rb_patricia_node_t *pnode;
+	rb_dlink_list list;
+	rb_dlink_node *ptr, *next;
 	struct ConfItem *aconf;
+	
+	memset(&list, 0, sizeof(list));
+	
 	RB_PATRICIA_WALK(dline_tree->head, pnode)
 	{
 		aconf = pnode->data;
 		if(!(aconf->flags & CONF_FLAGS_TEMPORARY))
 		{
-			remove_dline(aconf);	
+			rb_dlinkAddAlloc(aconf, &list);
 		}		
 	}
 	RB_PATRICIA_WALK_END;
+	
+	RB_DLINK_FOREACH_SAFE(ptr, next, list.head)
+	{
+		aconf = ptr->data;
+		remove_dline(aconf);
+		rb_free_rb_dlink_node(ptr);
+	}
 }
 
 void
-- 
2.7.4

